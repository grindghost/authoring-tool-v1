<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mon journal de bord</title>

    <style>

      * {
        margin: 0;
      }

      iframe {
        width: 800px;
        height: 446px;
        overflow: hidden;
      }

      body {
        overflow: hidden;
      }
    </style>

    <script type="text/javascript" src="./xapiwrapper/lib/cryptojs_v3.1.2.js"></script>
    <script type="text/javascript" src="./xapiwrapper/dist/xapiwrapper.min.js"></script>

  </head>

  <body spellcheck="false">
    <iframe
      id="dynamicIframe"
      src=""
      frameborder="0"
      allowfullscreen="allowfullscreen"
      allow="geolocation *; microphone *; camera *; midi *; encrypted-media *"
      title="Interactive Video"
      scrolling="no"
    ></iframe>
  </body>

  <script defer>

    // Function to get the LMS user
    function getLMSUser() {

      // Check if LMS is injecting xAPI config
      if (window.ADL && ADL.XAPIWrapper.lrs) {
          const lrsConfig = ADL.XAPIWrapper.lrs;

          // Example: Extract the user from the stored xAPI config
          if (lrsConfig.actor) {
              // console.log("LMS-injected user:", lrsConfig.actor);
              return lrsConfig.actor;
          }
      }

      // Return default fake user if LMS does not inject info
      return {
          mbox: "mailto:unknown@example.com",
          name: "Unknown User",
          objectType: "Agent"
      };
      }

    // Scaler function
    function Scaler() {
      try {
        const container = document.getElementsByTagName("*")[0];
        if (window.innerWidth <= 801) {

          // Remove any previous styles related to scale/transform to prevent bloat
          container.style.removeProperty("transform-origin");
          container.style.removeProperty("transform");

          let wrapWidth = 800; // width of the wrapper
          let wrapHeight = 446; // height of the wrapper
          let childWidth = window.innerWidth; // width of child iframe
          let childHeight = window.innerHeight; // child height
          let wScale = childWidth / wrapWidth;
          let hScale = childHeight / wrapHeight;
          let scale = Math.min(wScale, hScale); // get the lowest ratio

          // Instead of using setAttribute, update individual style properties
          container.style.transform = `scale(${scale})`;
          container.style.transformOrigin = "left top";
          container.style.maxWidth = "800px";
        }
      } catch (error) {
        console.error(error);
      }
    }


      // Listen for the message from the child
    window.addEventListener('message', function(event) {
        // You may want to validate the origin of the message for security reasons
        // if (event.origin !== 'https://your-child-frame-origin.com') {
        //    return; // Ignore the message if itâ€™s not from the expected origin
        // }
        const data = event.data;

        if (data.action === 'openNewWindow') {
            window.open(data.url, '_blank'); // Open the URL in a new window/tab
        }
    });

    window.addEventListener("DOMContentLoaded", function () {
        const user = getLMSUser();
        const iframe = document.getElementById("dynamicIframe");

        // Encode user data as a query string
        const userParams = new URLSearchParams({
            mbox: user.mbox,
            name: user.name
        }).toString();

        // Update iframe src dynamically
        iframe.src = `provider.html?${userParams}`;
    });

    window.addEventListener("DOMContentLoaded", Scaler, false);
    window.addEventListener("resize", Scaler, false);
  </script>
</html>
